# covpeek

Cross-language Coverage Report CLI Parser in Go

Parse coverage reports from Rust, Go, TypeScript, and JavaScript with one unified tool.

## Features

- **Multi-language Support**: Parses coverage files from:
  - **Rust**: LCOV format (`.lcov`, `.info`) generated by grcov or tarpaulin
  - **Go**: Native coverage format (`.out`)
  - **TypeScript/JavaScript**: LCOV format (`lcov.info`) generated by nyc (Istanbul)
  
- **Auto-detection**: Automatically detects coverage file format by extension or content
- **Multiple Output Formats**: Summary, detailed, or JSON output
- **Robust Parsing**: Handles malformed lines gracefully with warnings
- **High Test Coverage**: >80% test coverage for all parser modules

## Install

Export the path to the private go packages. E.g.:

    export GOPRIVATE=git.kernel.fun
    
Then configure the git config to access the server via SSH:

    git config --global --edit
    
Add the following to the file:

	[url "ssh://gitea@git.kernel.fun:64006/"]
		insteadOf = https://git.kernel.fun/

Then the package can be installed:

    go get -u git.kernel.fun/chapati.systems/covpeek

## Usage

### Parse a Coverage File

Parse a coverage file and display summary:

    covpeek parse --file coverage.lcov

Parse with different output formats:

    # Summary format (default)
    covpeek parse --file coverage.lcov --format summary
    
    # Detailed format with line-by-line coverage
    covpeek parse --file coverage.out --format detailed
    
    # JSON format for programmatic use
    covpeek parse --file lcov.info --format json

Force a specific format (bypass auto-detection):

    covpeek parse --file coverage.txt --force-format lcov
    covpeek parse --file coverage.dat --force-format go

### Examples

Parse Rust coverage (generated by grcov):

    cargo tarpaulin --out Lcov
    covpeek parse --file lcov.info

Parse Go coverage:

    go test -coverprofile=coverage.out ./...
    covpeek parse --file coverage.out

Parse TypeScript/JavaScript coverage (generated by nyc):

    nyc --reporter=lcov npm test
    covpeek parse --file coverage/lcov.info

## Supported Coverage Formats

### LCOV Format

Used by Rust (grcov, tarpaulin) and TypeScript/JavaScript (nyc):

- File extensions: `.lcov`, `.info`, `lcov.info`
- Records: TN, SF, FN, FNDA, DA, LH, LF, end_of_record
- Branch coverage (BRF, BRH, BRDA) is supported but optional

### Go Coverage Format

Native Go coverage format:

- File extension: `.out`
- Format: `mode: set|count|atomic` followed by coverage entries
- Example: `file.go:5.10,7.2 1 1`

## Deploy on Server

1. Create the Config file on the Server
2. Create the Binary for the Server
3. Upload the Binary to the Server
4. Make the Binary executable `chmod +x covpeek`

## Development

Install pre-commit hooks:

    pre-commit install

Run program:

    go run ./cmd/covpeek

Run tests:

    go test ./...

Run tests with coverage:

    go test -coverprofile=coverage.out ./...
    go tool cover -html=coverage.out

## Build

### Build for current platform

    go build -o covpeek ./cmd/covpeek

### Build for Linux

See https://freshman.tech/snippets/go/cross-compile-go-programs/

    GOOS=linux GOARCH=amd64 go build -o covpeek ./cmd/covpeek

### Build for macOS

    GOOS=darwin GOARCH=arm64 go build -o covpeek ./cmd/covpeek

## Project Structure

```
covpeek/
├── cmd/covpeek/          # CLI application entry point
│   ├── main.go
│   ├── root.go
│   └── parse.go
├── pkg/
│   ├── models/           # Data structures
│   │   └── coverage.go
│   └── parser/           # Coverage file parsers
│       ├── lcov.go       # LCOV format parser
│       ├── lcov_test.go
│       ├── gocover.go    # Go coverage parser
│       └── gocover_test.go
├── internal/
│   └── detector/         # Format auto-detection
│       ├── detector.go
│       └── detector_test.go
└── testdata/             # Sample coverage files for testing
```

## Testing

All parser modules maintain >80% test coverage with comprehensive test cases including:

- Valid coverage files
- Malformed/incomplete entries
- Edge cases (empty files, missing fields)
- Multiple files
- Different coverage modes

Run tests:

    go test -v ./...

## License

See LICENSE file for details.